<html>
<head>
<style>
@keyframes fadeout {
	from {opacity: 1;} to {opacity: 0}
}
.fade-fast{
	animation: 5s fadeout;
	opacity: 0;
	transition: transform 5s;
}
.bwoinkdiv {
	background-color: white;
	display: inline-block;
	max-width: 500px;
	position: absolute;
	overflow-wrap: break-word;
	overflow: hidden;
}
</style>
<script src="ngeurl.js"></script>
<script src="bwoinks.js"></script>
<script>
var bwoinkbuf;
var catbuf;
var bwoinkrate = 0.6170518856924528;
var req = new XMLHttpRequest();
var ctx = new AudioContext();
var keytonote = {};
req.responseType = "arraybuffer";
req.open("GET", "https://raw.githubusercontent.com/tgstation/tgstation/master/sound/effects/adminhelp.ogg", true);
req.onload = () => {
	ctx.decodeAudioData(req.response, (buf) => {
		bwoinkbuf = buf;
	});
};
req.send();
var req2 = new XMLHttpRequest();
req2.responseType = "arraybuffer";
req2.open("GET", ngeurl, true);
req2.onload = () => {
	ctx.decodeAudioData(req2.response, (buf) => {
		catbuf = buf;
	});
};
req2.send();

var tostop = new Set();

function playbwoink(note, time = 0, sayid) {
	if(time < ctx.currentTime && time != 0) return;
	var src = ctx.createBufferSource();
	src.buffer = bwoinkbuf;
	src.playbackRate.value = bwoinkrate;
	src.detune.value = note*100;
	src.connect(ctx.destination);
	src.start(time);
	tostop.add(src);
	src.onended = ()=>{tostop.delete(src);}
	if(sayid != undefined) {
		setTimeout(()=>{if(tostop.has(src)){console.log(sayid); addbwoink();}}, 1000*(time - ctx.currentTime));
	}
}

var recording = [{"note":0,"delay":1.0500453514739377},{"note":3,"delay":1.8314739229024894},{"note":5,"delay":2.4816326530612116},{"note":3,"delay":2.980861678004544},{"note":5,"delay":3.5120181405895607},{"note":5,"delay":3.8893424036281203},{"note":10,"delay":4.571428571428584},{"note":8,"delay":4.951655328798182},{"note":7,"delay":5.4421768707483125},{"note":5,"delay":5.63954648526078},{"note":7,"delay":5.9414058956916165},{"note":7,"delay":6.980498866213139},{"note":10,"delay":7.659682539682535},{"note":12,"delay":8.411428571428559},{"note":5,"delay":8.951292517006806},{"note":3,"delay":9.520181405895698},{"note":10,"delay":9.92943310657597},{"note":10,"delay":10.32997732426304},{"note":7,"delay":10.660861678004522},{"note":10,"delay":11.020770975056678},{"note":10,"delay":11.44163265306122},{"note":12,"delay":12.059863945578229},{"note":3,"delay":22.781678004535166},{"note":-2,"delay":23.231564625850353},{"note":3,"delay":24.009433106575983},{"note":3,"delay":24.250340136054433},{"note":5,"delay":24.581224489795915},{"note":-2,"delay":24.909206349206357},{"note":-2,"delay":25.092063492063517},{"note":-2,"delay":25.840907029478473},{"note":7,"delay":26.06149659863948},{"note":8,"delay":26.421405895691606},{"note":7,"delay":26.76099773242632},{"note":5,"delay":26.981587301587325},{"note":3,"delay":27.30956916099774},{"note":5,"delay":27.669478458049895},{"note":7,"delay":27.8813605442177},{"note":8,"delay":28.209342403628142},{"note":7,"delay":28.58086167800454},{"note":0,"delay":28.789841269841276},{"note":0,"delay":29.521269841269856},{"note":2,"delay":29.61995464852609},{"note":3,"delay":29.77959183673471},{"note":3,"delay":30.139501133786865},{"note":2,"delay":30.470385487528347},{"note":2,"delay":30.699682539682556},{"note":3,"delay":31.38176870748299},{"note":5,"delay":31.492063492063494},{"note":10,"delay":31.651700680272114},{"note":8,"delay":31.991292517006826},{"note":7,"delay":32.33088435374151},{"note":5,"delay":32.589206349206364},{"note":8,"delay":33.32934240362812},{"note":8,"delay":33.54122448979592},{"note":7,"delay":33.86049886621316},{"note":5,"delay":34.20009070294785},{"note":7,"delay":34.440997732426325},{"note":0,"delay":34.87927437641724},{"note":0,"delay":35.401723356009086},{"note":2,"delay":36.06058956916101},{"note":2,"delay":36.30149659863946},{"note":3,"delay":37.697414965986354},{"note":-2,"delay":38.14730158730157},{"note":3,"delay":38.80907029478453},{"note":3,"delay":39.079002267573685},{"note":5,"delay":39.409886621315195},{"note":-2,"delay":39.75818594104305},{"note":-2,"delay":39.97877551020406},{"note":-2,"delay":40.63764172335601},{"note":7,"delay":40.87854875283443},{"note":8,"delay":41.25006802721089},{"note":7,"delay":41.63900226757369},{"note":5,"delay":41.89732426303851},{"note":3,"delay":42.22820861678002},{"note":5,"delay":42.59972789115642},{"note":7,"delay":42.788390022675685},{"note":8,"delay":43.15990929705214},{"note":7,"delay":43.48789115646258},{"note":0,"delay":43.7200907029478},{"note":0,"delay":44.44861678004531},{"note":2,"delay":44.57922902494329},{"note":3,"delay":44.68952380952379},{"note":3,"delay":45.06975056689339},{"note":2,"delay":45.4093424036281},{"note":2,"delay":45.62993197278911},{"note":3,"delay":46.309115646258476},{"note":5,"delay":46.378775510204036},{"note":8,"delay":46.52970521541948},{"note":7,"delay":46.869297052154195},{"note":5,"delay":47.20888888888885},{"note":3,"delay":47.4701133786848},{"note":7,"delay":48.128979591836696},{"note":7,"delay":48.38730158730158},{"note":5,"delay":48.758820861677975},{"note":4,"delay":49.057777777777744},{"note":5,"delay":49.33931972789111},{"note":7,"delay":49.69922902494329},{"note":8,"delay":50.01850340136053},{"note":7,"delay":50.3087528344671},{"note":3,"delay":52.188480725623606},{"note":3,"delay":52.499047619047644},{"note":2,"delay":52.86766439909297},{"note":3,"delay":53.07954648526078},{"note":3,"delay":53.40752834467122},{"note":2,"delay":53.73841269841273},{"note":5,"delay":53.999637188208624},{"note":5,"delay":54.34793650793654},{"note":3,"delay":54.68752834467125},{"note":2,"delay":54.91972789115647},{"note":0,"delay":55.25931972789118},{"note":2,"delay":55.607619047619096},{"note":3,"delay":55.86884353741499},{"note":3,"delay":56.22004535147397},{"note":2,"delay":56.539319727891154},{"note":5,"delay":56.777324263038565},{"note":2,"delay":57.119818594104345},{"note":0,"delay":57.4681179138322},{"note":-2,"delay":57.71773242630388},{"note":3,"delay":59.639183673469404},{"note":3,"delay":59.970068027210914},{"note":2,"delay":60.32997732426304},{"note":3,"delay":60.56798185941045},{"note":3,"delay":60.91918367346943},{"note":2,"delay":61.22975056689347},{"note":5,"delay":61.467755102040826},{"note":5,"delay":61.80734693877554},{"note":3,"delay":62.14984126984132},{"note":2,"delay":62.41977324263041},{"note":3,"delay":62.76807256235833},{"note":5,"delay":63.06993197278916},{"note":7,"delay":63.30793650793652},{"note":8,"delay":63.6678458049887},{"note":7,"delay":64.01904761904763},{"note":5,"delay":64.2599546485261},{"note":3,"delay":64.59954648526082},{"note":5,"delay":64.94784580498867},{"note":7,"delay":65.18875283446715},{"note":0,"delay":67.08979591836737},{"note":3,"delay":67.5512925170068},{"note":5,"delay":68.00117913832196},{"note":3,"delay":68.3291609977324},{"note":5,"delay":68.7006802721088},{"note":5,"delay":68.90965986394554},{"note":10,"delay":69.40018140589564},{"note":8,"delay":69.62077097505664},{"note":7,"delay":69.87038548752832},{"note":5,"delay":70.00970521541944},{"note":7,"delay":70.29995464852607},{"note":7,"delay":70.8107936507937},{"note":10,"delay":71.28099773242627},{"note":12,"delay":71.71056689342402},{"note":5,"delay":72.02984126984131},{"note":3,"delay":72.36943310657591},{"note":2,"delay":72.65097505668939},{"note":2,"delay":72.87156462585028},{"note":0,"delay":73.10086167800455},{"note":2,"delay":73.35918367346937},{"note":5,"delay":73.6000907029478},{"note":3,"delay":73.66975056689341},{"note":3,"delay":73.93968253968251},{"note":0,"delay":74.5209070294784},{"note":3,"delay":74.99981859410423},{"note":5,"delay":75.44099773242624},{"note":3,"delay":75.78929705215421},{"note":5,"delay":76.18113378684802},{"note":5,"delay":76.4307482993197},{"note":5,"delay":76.68907029478453},{"note":10,"delay":76.88063492063486},{"note":8,"delay":77.10993197278913},{"note":7,"delay":77.35083900226755},{"note":5,"delay":77.461133786848},{"note":7,"delay":77.69043083900226},{"note":7,"delay":78.2709297052154},{"note":10,"delay":78.7614512471655},{"note":12,"delay":79.21133786848065},{"note":5,"delay":79.53061224489795},{"note":3,"delay":79.8614965986394},{"note":10,"delay":80.1314285714285},{"note":10,"delay":80.36943310657591},{"note":7,"delay":80.60163265306119},{"note":10,"delay":80.79029478458051},{"note":10,"delay":81.08054421768702},{"note":12,"delay":81.39111111111106},{"note":0,"delay":82.01006802721088},{"note":3,"delay":82.48897959183671},{"note":5,"delay":82.95047619047614},{"note":3,"delay":83.26975056689344},{"note":5,"delay":83.6702947845805},{"note":5,"delay":83.90829931972792},{"note":5,"delay":84.18984126984128},{"note":10,"delay":84.36979591836734},{"note":8,"delay":84.57006802721082},{"note":7,"delay":84.77904761904756},{"note":5,"delay":84.9183673469388},{"note":7,"delay":85.17959183673463},{"note":7,"delay":85.76879818594102},{"note":10,"delay":86.21868480725618},{"note":12,"delay":86.64825396825393},{"note":5,"delay":86.9994557823129},{"note":3,"delay":87.35936507936503},{"note":10,"delay":87.61768707482997},{"note":10,"delay":87.8585941043084},{"note":7,"delay":88.0791836734694},{"note":10,"delay":88.34040816326524},{"note":10,"delay":88.55809523809523},{"note":12,"delay":88.88897959183669}];
var isrecording = false;
var recordtime = 0;

function record(timeat = 0) {
	isrecording = true;
	recordtime = ctx.currentTime - timeat;
	var ngesrc = ctx.createBufferSource();
	ngesrc.buffer = catbuf;
	ngesrc.connect(ctx.destination);
	ngesrc.start(0, timeat);
	tostop.add(ngesrc);
	ngesrc.onended = () => {tostop.delete(ngesrc); isrecording = false;};
	for(var i = 0; i < recording.length; i++) {
		playbwoink(recording[i].note, recording[i].delay+recordtime, `${recording[i].delay}s: #${i}`);
	}
}

function stop() {
	for(var source of tostop) {
		source.stop();
	}
	isrecording = false;
	tostop.clear();
}

function spliceafter(time) {
	for(var i = 0; i < recording.length; i++) {
		if(recording[i].delay > time) {
			recording.splice(i, 1);
			i--;
		}
	}
}

document.addEventListener("keydown", (e) => {
	var note = keytonote[e.key];
	if(note == undefined) return;
	playbwoink(note);
	if(isrecording) {
		recording.push({note, delay: ctx.currentTime-recordtime});
	}
});

function addbwoink() {
	var bwoinkdiv = document.createElement("div");
	bwoinkdiv.classList.add("bwoinkdiv");
	bwoinkdiv.innerHTML = bwoinklist[Math.floor(Math.random()*bwoinklist.length)];
	
	bwoinkdiv.style[Math.random() < .5 ? "top" : "bottom"] = Math.random()*360;
	bwoinkdiv.style[Math.random() < .5 ? "left" : "right"] = Math.random()*540;
	bwoinkdiv.style.transform = `rotate(${Math.random()*20-10}deg)`;
	
	var bwoinkwindow = document.getElementById("bwoinkwindow");
	bwoinkwindow.appendChild(bwoinkdiv);
	
	bwoinkdiv.classList.add("fade-fast");
	setTimeout(()=>{
		bwoinkdiv.style.transform = `translate(${Math.random()*100-50}px, ${Math.random()*100-50}px) rotate(${Math.random()*20-10}deg)`;
	}, 16.6667);
	
	setTimeout(()=>{bwoinkwindow.removeChild(bwoinkdiv)}, 5000);
}

(function genNotes() {
	var note = 0;
	for(var key of ['q','2','w','3','e','r','5','t','6','y','7','u','i','9','o','0','p','[','=',']']) {
		keytonote[key] = note++;
	}
	note = -12;
	for(var key of ['z','s','x','d','c','v','g','b','h','n','j','m',',','l','.',';','/']) {
		keytonote[key] = note++;
	}
})();
setInterval(() => {
	if(isrecording)
		document.getElementById('timer').innerHTML = isrecording ? (ctx.currentTime-recordtime) : 0;
}, 16.6667);
</script>
</head>
<body onkeydown="">
<input type="text" value="0" id="recordtime">
<input type="button" value="start" onclick="record(document.getElementById('recordtime').value)">
<input type="button" value="stop" onclick="stop()">
<span id='timer'>0</span><br><br>
<div style='position:relative;width:1280px;height:720px;border:1px solid red;background:black;font-family:Verdana;font-size:13px' id='bwoinkwindow'></div>
</body>
</html>